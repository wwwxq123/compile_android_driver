name: Android Kernel Driver Builder
on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (e.g., 11 for umi)'
        required: true
        default: '11'
      kernel_version:
        description: 'Kernel Version (e.g., 4.19)'
        required: true
        default: '4.19'
      driver_name:
        description: 'Driver Module Name (e.g., mydriver.ko)'
        required: true
      target_arch:
        description: 'Target Architecture'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Prepare kerneldriver directory
        run: |
          mkdir kerneldriver
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/ 2>/dev/null || true
          if [ ! "$(ls -A kerneldriver)" ]; then
            echo "Warning: No source files found in ./code/"
          fi

      - name: Clone Xiaomi Kernel Source
        run: |
          git clone --depth=1 https://github.com/MiCode/Xiaomi_Kernel_OpenSource -b umi-q-oss android-kernel

      - name: Copy kerneldriver
        run: |
          cd android-kernel
          cp -r ../kerneldriver drivers/

      - name: Modify Makefile
        run: |
          cd android-kernel
          echo "obj-y += kerneldriver/" >> drivers/Makefile

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3 git

      # >>> 修复步骤：使用 Python 脚本精准修复 <<<
      - name: Fix Python 2/3 compatibility (Precise Fix)
        run: |
          cd android-kernel
          # 使用 Python3 运行一段代码来修复 gcc-wrapper.py
          # 这样比 sed 安全得多，只会修改 print 语句
          python3 << 'EOF'
          import re

          filename = 'scripts/gcc-wrapper.py'
          try:
              with open(filename, 'r') as f:
                  lines = f.readlines()

              new_lines = []
              for line in lines:
                  # 匹配行首可能有空格，然后是 print，接着是空格
                  # 只修改这种简单的 print 语句
                  if re.match(r'^(\s*)print\s+', line):
                      # 移除行尾换行符
                      l = line.rstrip('\n')
                      # 分割 print 和后面的内容
                      parts = re.split(r'(\s*print\s+)', l, 1)
                      if len(parts) == 3:
                          # 重组为 print(...)
                          fixed_line = parts[0] + parts[1] + '(' + parts[2] + ')\n'
                          new_lines.append(fixed_line)
                      else:
                          new_lines.append(line)
                  else:
                      new_lines.append(line)

              with open(filename, 'w') as f:
                  f.writelines(new_lines)
              print("Successfully fixed gcc-wrapper.py")
          except FileNotFoundError:
              print("File not found, skipping...")
          EOF

      - name: Build kernel module
        run: |
          cd android-kernel
          
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # 尝试加载 defconfig
          make arch/arm64/configs/umi_defconfig || make defconfig
          
          # 开始编译模块
          make modules -j$(nproc)
        continue-on-error: true

      - name: Find and Upload artifacts
        run: |
          cd android-kernel
          find . -name "*.ko" -exec cp {} ../ \;
          echo "Found kernel objects:"
          ls -lh ../*.ko 2>/dev/null || echo "No .ko files found"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: kernel-driver-${{ github.event.inputs.target_arch }}
          path: |
            *.ko
