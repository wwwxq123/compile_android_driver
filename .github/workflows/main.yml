name: Android Kernel Driver Builder
on: workflow_dispatch
  inputs:
    android_version:
      description: 'Android Version (Kernel) (e.g., 11, 12, 13)'
      required: true
    kernel_version:
      description: 'Kernel Version (e.g., 4.19, 5.4, 5.10)'
      required: true
    driver_name:
      description: 'Driver Module Name (e.g., mydriver.ko)'
      required: true
    target_arch:
      description: 'Target Architecture (aarch64, x86_64, etc.)'
      required: true
      default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Prepare kerneldriver directory
        run: |
          mkdir kerneldriver
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/

      - name: Clone Xiaomi Kernel Source
        run: |
          git clone --depth=1 https://github.com/MiCode/Xiaomi_Kernel_OpenSource -b umi-q-oss android-kernel

      - name: Copy kerneldriver to drivers
        run: |
          cd android-kernel
          cp -r ../kerneldriver drivers/

      - name: Add driver to drivers Makefile
        run: |
          cd android-kernel
          # 添加内核驱动目录到 drivers/Makefile
          grep -q "kerneldriver" drivers/Makefile || echo "obj-y += kerneldriver/" >> drivers/Makefile

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3 git

      - name: Install build tools (for cross-compilation)
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build kernel module
        run: |
          cd android-kernel
          
          # 为 aarch64 架构设置交叉编译
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # 使用现有的 defconfig
          make arch/arm64/configs/umi_defconfig || \
          make arch/arm64/configs/perf_defconfig || \
          make defconfig
          
          # 只编译驱动模块
          make M=drivers/kerneldriver modules
          
          # 设置输出路径
          DRIVER_PATH=$(find drivers/kerneldriver -name "${{ github.event.inputs.driver_name }}.ko" | head -n 1)
          if [ -n "$DRIVER_PATH" ]; then
            mkdir -p output
            cp "$DRIVER_PATH" output/
            echo "DRIVER_PATH=output/${{ github.event.inputs.driver_name }}.ko" >> $GITHUB_ENV
          else
            echo "Warning: Driver module not found"
            find . -name "*.ko" | head -20
          fi
        continue-on-error: true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: kernel-driver-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.driver_name }}
          path: |
            ${{ env.DRIVER_PATH }}
