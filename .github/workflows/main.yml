name: Android Kernel Driver Builder
on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (e.g., 11 for umi)'
        required: true
        default: '11'
      kernel_version:
        description: 'Kernel Version (e.g., 4.19)'
        required: true
        default: '4.19'
      driver_name:
        description: 'Driver Module Name (e.g., mydriver.ko)'
        required: true
      target_arch:
        description: 'Target Architecture'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Prepare kerneldriver directory
        run: |
          mkdir kerneldriver
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/ 2>/dev/null || true
          # 确保目录存在且不为空
          if [ ! "$(ls -A kerneldriver)" ]; then
            echo "Warning: No source files found in ./code/"
          fi

      - name: Clone Xiaomi Kernel Source
        # 直接克隆小米仓库，不使用 repo 工具
        run: |
          git clone --depth=1 https://github.com/MiCode/Xiaomi_Kernel_OpenSource -b umi-q-oss android-kernel

      - name: Copy kerneldriver
        run: |
          cd android-kernel
          cp -r ../kerneldriver drivers/

      - name: Modify Makefile
        run: |
          cd android-kernel
          # 将驱动目录加入编译系统
          echo "obj-y += kerneldriver/" >> drivers/Makefile
          echo "Added kerneldriver to drivers/Makefile"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3 git

      - name: Build kernel module
        run: |
          cd android-kernel
          
          # 设置构建环境变量
          export ARCH=arm64
          export SUBARCH=arm64
          
          # 小米 umi 分支通常使用 build.config.gki.aarch64
          # 如果该文件不存在，可能需要调整为 build.config.umi 或手动指定 defconfig
          if [ -f "common/build.config.gki.aarch64" ]; then
             BUILD_CONFIG=common/build.config.gki.aarch64 LTO=thin build/build.sh -j$(nproc)
          elif [ -f "build.config.umi" ]; then
             BUILD_CONFIG=build.config.umi build/build.sh -j$(nproc)
          else
             # 兜底方案：直接使用 make
             make arch/arm64/configs/umi_defconfig
             make modules -j$(nproc)
          fi
        continue-on-error: true

      - name: Find and Upload artifacts
        run: |
          cd android-kernel
          # 查找生成的 .ko 文件
          find . -name "*.ko" -exec cp {} ../ \;
          echo "Found kernel objects:"
          ls -lh ../*.ko 2>/dev/null || echo "No .ko files found in root"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: kernel-driver-${{ github.event.inputs.target_arch }}
          path: |
            *.ko
