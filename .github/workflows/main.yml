name: Android Kernel Driver Builder
on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (e.g., 11 for umi)'
        required: true
        default: '11'
      kernel_version:
        description: 'Kernel Version (e.g., 4.19)'
        required: true
        default: '4.19'
      driver_name:
        description: 'Driver Module Name (e.g., mydriver.ko)'
        required: true
      target_arch:
        description: 'Target Architecture'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Prepare kerneldriver directory
        run: |
          mkdir kerneldriver
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/ 2>/dev/null || true
          if [ ! "$(ls -A kerneldriver)" ]; then
            echo "Warning: No source files found in ./code/"
          fi

      - name: Clone Xiaomi Kernel Source
        run: |
          git clone --depth=1 https://github.com/MiCode/Xiaomi_Kernel_OpenSource -b umi-q-oss android-kernel

      - name: Copy kerneldriver
        run: |
          cd android-kernel
          cp -r ../kerneldriver drivers/

      - name: Modify Makefile
        run: |
          cd android-kernel
          echo "obj-y += kerneldriver/" >> drivers/Makefile

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3 git

      # >>> 新增步骤：修复 Python 3 兼容性 <<<
      - name: Fix Python 2/3 compatibility
        run: |
          cd android-kernel
          # 修复 scripts/gcc-wrapper.py 中的 print 语法错误 (Python 2 -> Python 3)
          if [ -f "scripts/gcc-wrapper.py" ]; then
            sed -i 's/print "/print("/g' scripts/gcc-wrapper.py
            sed -i 's/",/",)/g' scripts/gcc-wrapper.py
            echo "Fixed gcc-wrapper.py for Python 3"
          fi

      - name: Build kernel module
        run: |
          cd android-kernel
          
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # 尝试加载 defconfig
          # 小米 umi 可能使用 umi_defconfig，如果不存在则用默认的
          make arch/arm64/configs/umi_defconfig || make defconfig
          
          # 开始编译模块
          make modules -j$(nproc)
        continue-on-error: true

      - name: Find and Upload artifacts
        run: |
          cd android-kernel
          # 将编译出的 .ko 文件复制到外层
          find . -name "*.ko" -exec cp {} ../ \;
          echo "Found kernel objects:"
          ls -lh ../*.ko 2>/dev/null || echo "No .ko files found"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: kernel-driver-${{ github.event.inputs.target_arch }}
          path: |
            *.ko
